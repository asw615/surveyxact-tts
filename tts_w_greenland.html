</style>
</head>
<body>
  <!-- 1. Martha TTS library (Greenlandic) -->
  <script src="https://oqaasileriffik.gl/d/martha.js"></script>

  <!-- 2. CSS loader animation (da/en) -->
  <style>
    .loader {
      width: 16px;
      margin-left: 10px;
      aspect-ratio: 1;
      display: inline-block;
      vertical-align: middle;
      --c: no-repeat linear-gradient(#000 0 0);
      background:
        var(--c) 0% 50%,
        var(--c) 50% 50%,
        var(--c) 100% 50%;
      background-size: 20% 100%;
      animation: l1 1s infinite linear;
    }
    @keyframes l1 {
      0%   { background-size: 20% 100%, 20% 100%, 20% 100% }
      33%  { background-size: 20% 10%,  20% 100%, 20% 100% }
      50%  { background-size: 20% 100%, 20% 10%,  20% 100% }
      66%  { background-size: 20% 100%, 20% 100%, 20% 10%  }
      100% { background-size: 20% 100%, 20% 100%, 20% 100% }
    }
  </style>

  <script>
  document.addEventListener('DOMContentLoaded', async function() {
    // 3. GitHub TTS mapping (da/en)
    const TTS_MAPPING_URL = "https://asw615.github.io/surveyxact-tts/tts_mapping.json";
    let ttsMapping = {};
    try {
      const response = await fetch(TTS_MAPPING_URL);
      ttsMapping = await response.json();
      console.log("TTS Mapping loaded:", ttsMapping);
    } catch (error) {
      console.error("Failed to load TTS mapping:", error);
    }

    // 4. Loader animation
    function startReadingAnimation(iconElem) {
      iconElem.style.display = "none";
      const loader = document.createElement("div");
      loader.className = "loader";
      iconElem.parentNode.insertBefore(loader, iconElem.nextSibling);
      iconElem._currentAnim = loader;
    }
    function stopReadingAnimation(iconElem) {
      if (iconElem._currentAnim) {
        iconElem._currentAnim.remove();
        iconElem._currentAnim = null;
      }
      iconElem.style.display = "inline-block";
    }

    // 5. Detect active language
    let activeLang = "da";
    const langBar = document.querySelector("div.language-bar");
    if (langBar) {
      const activeBtn = langBar.querySelector("input.language-button.active");
      if (activeBtn) {
        const parts = activeBtn.getAttribute("name").split('.');
        if (parts.length > 1) activeLang = parts[1];
      }
    }
    console.log("Active language detected:", activeLang);

    // 6. Combined TTS function
    function playTTS(text, iconElem, lang, elem) {
      if (lang === "kl") {
        // Martha for Greenlandic
        iconElem.className = "martha-button martha-skip";
        // CRUCIAL: Use the 'elem.id', not parentNode
        iconElem.setAttribute("data-martha-id", elem.id);
        martha.click.call(iconElem, new Event("click"));
      } else if (ttsMapping[text]) {
        // da/en -> mapped audio
        const audio = new Audio(ttsMapping[text]);
        audio.play();
        startReadingAnimation(iconElem);
        audio.onended = () => stopReadingAnimation(iconElem);
      } else {
        console.warn("No TTS file found for:", text);
      }
    }

    // 7. Speaker icon
    const SPEAKER_ICON_URL = "https://upload.wikimedia.org/wikipedia/commons/thumb/2/21/Speaker_Icon.svg/480px-Speaker_Icon.svg.png";

    // 8. Classes for icons
    const targetClasses = [
      "text-element",
      "question-title",
      "closed-vertical-choice",
      "row-header-text",
      "battery-grid"
    ];

    // 9. Questions container
    const questionsContainer = document.querySelector("div.questions");
    if (!questionsContainer) {
      console.error("Questions container not found.");
      return;
    }

    // 10. Insert icons
    targetClasses.forEach(cls => {
      const elems = questionsContainer.getElementsByClassName(cls);
      Array.from(elems).forEach(function(elem) {
        if (elem.classList.contains("audio-icon-added")) return;
        if (!elem.id) {
          elem.id = "elem_" + Math.random().toString(36).substr(2, 9);
        }

        // If in battery-grid AND has an input/label => skip
        const inBattery = !!elem.closest(".battery-grid");
        if (inBattery && (elem.querySelector("input") || elem.querySelector("label"))) {
          return; // no icon on radio/checkbox items
        }

        // Check if inside a <td>
        const inTableCell = !!elem.closest("td");

        // (A) closed-vertical-choice
        if (cls === "closed-vertical-choice") {
          // If itâ€™s a <label>
          if (elem.tagName.toLowerCase() === "label") {
            elem.style.display = "inline-flex";
            elem.style.alignItems = "center";

            const icon = document.createElement("img");
            icon.src = SPEAKER_ICON_URL;
            icon.alt = "Speaker";
            icon.style.width = "24px";
            icon.style.height = "24px";
            icon.style.marginLeft = "4px";
            icon.style.cursor = "pointer";
            icon.style.display = "inline-block";
            icon.style.verticalAlign = "middle";

            icon.addEventListener("click", function(e) {
              e.preventDefault();
              const text = elem.innerText.trim();
              if (!text) return;
              playTTS(text, icon, activeLang, elem);
            });

            elem.appendChild(icon);
            elem.insertAdjacentHTML("afterend", "<br>");
            elem.classList.add("audio-icon-added");

          } else {
            // Wrap in a span
            const wrapper = document.createElement("span");
            wrapper.style.display = "inline-flex";
            wrapper.style.alignItems = "center";
            elem.parentNode.insertBefore(wrapper, elem);
            wrapper.appendChild(elem);

            const icon = document.createElement("img");
            icon.src = SPEAKER_ICON_URL;
            icon.alt = "Speaker";
            icon.style.width = "24px";
            icon.style.height = "24px";
            icon.style.marginLeft = "4px";
            icon.style.cursor = "pointer";
            icon.style.display = "inline-block";
            icon.style.verticalAlign = "middle";

            icon.addEventListener("click", function(e) {
              e.preventDefault();
              const text = elem.innerText.trim();
              if (!text) return;
              playTTS(text, icon, activeLang, elem);
            });

            wrapper.appendChild(icon);
            wrapper.insertAdjacentHTML("afterend", "<br>");
            elem.classList.add("audio-icon-added");
          }

        // (B) Not in a table cell
        } else if (!inTableCell) {
          const wrapper = document.createElement("div");
          wrapper.style.display = "inline-flex";
          wrapper.style.alignItems = "center";
          elem.parentNode.insertBefore(wrapper, elem);
          wrapper.appendChild(elem);

          const icon = document.createElement("img");
          icon.src = SPEAKER_ICON_URL;
          icon.alt = "Speaker";
          icon.style.width = "24px";
          icon.style.height = "24px";
          icon.style.marginLeft = "8px";
          icon.style.cursor = "pointer";
          icon.style.display = "inline-block";
          icon.style.verticalAlign = "middle";

          icon.addEventListener("click", function(e) {
            e.preventDefault();
            const text = elem.innerText.trim();
            if (!text) return;
            playTTS(text, icon, activeLang, elem);
          });

          wrapper.appendChild(icon);
          elem.classList.add("audio-icon-added");

        // (C) Inside a table cell
        } else {
          const icon = document.createElement("img");
          icon.src = SPEAKER_ICON_URL;
          icon.alt = "Speaker";
          icon.style.width = "24px";
          icon.style.height = "24px";
          icon.style.marginLeft = "4px";
          icon.style.cursor = "pointer";
          icon.style.display = "inline-block";
          icon.style.verticalAlign = "middle";

          icon.addEventListener("click", function(e) {
            e.preventDefault();
            const text = elem.innerText.trim();
            if (!text) return;
            playTTS(text, icon, activeLang, elem);
          });

          elem.insertAdjacentElement("beforeend", icon);
          elem.classList.add("audio-icon-added");
        }
      });
    });
  });
  </script>
</body>
</html>
